{{#if @card}}
  {{#if (eq @format "isolated")}}
    <section
      class="card-renderer-isolated
        {{this.mode}}
        {{if (and this.cardstackSession.isAuthenticated @cardSelected) "selected"}}
        {{concat "field-count-" this.fields.length}}
        {{@class}}
      "
      tabindex="0"
      data-test-card-renderer-isolated
      data-test-card-loaded={{stringify this.loadCard.isIdle}}
      {{on "focus" (action this.cardIsFocused true)}}
      {{did-insert this.focusCard true}}
      {{did-update this.cardUpdated @card}}
    >
      {{#if (and (eq @mode "view") (not @suppressHeader))}}
        {{#animated-value @card watch="isSelected" use=this.headerAnimation}}
          <CardRendererHeader
            @cardSelected={{if (and this.cardstackSession.isAuthenticated @cardSelected) true}}
            @card={{@card}}
            @buttonRoute="cards.card.edit.fields"
            @buttonText="Edit"
            @mode={{this.mode}}
            @contextMenuOpen={{@contextMenuOpen}}
            @setContextMenu={{@setContextMenu}}
          />
        {{/animated-value}}
      {{else if (not @suppressHeader)}}
        <CardRendererHeader
          @cardSelected={{true}}
          @card={{@card}}
          @buttonRoute="cards.card.view"
          @buttonText="Done Editing"
          @mode={{this.mode}}
          @contextMenuOpen={{@contextMenuOpen}}
          @setContextMenu={{@setContextMenu}}
        />
      {{/if}}
      {{!-- This is the card boundary, please don't set any card specific classes any higher in the DOM than this. --}}
      {{!-- If we need card specific styling above this level, then let's chat about it.                           --}}
      <div class="card-renderer-isolated--content
        {{concat (safe-css-string (if @card.canonicalURL @card.canonicalURL @card.adoptsFromURL)) "--isolated" }}
      ">
        {{#if @suppressHeader}}
          <div class="card-renderer-isolated--card-container card-boundary isolated">
            <Scaffold
              @card={{@card}}
              @feature="isolated-layout"
              @fields={{this.fields}}
              @mode={{this.mode}}
              @setFieldName={{@setFieldName}}
              @setCardValue={{@setCardValue}}
              @setCardReference={{@setCardReference}}
              @removeField={{@removeField}}
              @toggleStubField={{this.toggleStubField}}
              @setNeededWhenEmbedded={{@setNeededWhenEmbedded}}
              @setPosition={{@setPosition}}
              @selectField={{@selectField}}
              @selectedField={{@selectedField}}
              @selectedFieldName={{@selectedFieldName}}
              @dropField={{@dropField}}
            />
          </div>
        {{else}}
          {{#animated-value @card watch="isSelected" use=this.borderAnimation}}
            <div class="card-renderer-isolated--card-container card-boundary isolated {{if (and this.cardstackSession.isAuthenticated @card.isSelected) "selected"}}">
              {{#if @dropField}}
                <DropZone
                  @card={{@card}}
                  @dropField={{@dropField}}
                  @position={{0}}
                  @toggleStubField={{this.toggleStubField}}
                />
              {{/if}}
              <Scaffold
                @card={{@card}}
                @feature="isolated-layout"
                @fields={{this.fields}}
                @mode={{this.mode}}
                @setFieldName={{@setFieldName}}
                @setCardValue={{@setCardValue}}
                @setCardReference={{@setCardReference}}
                @removeField={{@removeField}}
                @toggleStubField={{this.toggleStubField}}
                @setNeededWhenEmbedded={{@setNeededWhenEmbedded}}
                @setPosition={{@setPosition}}
                @selectField={{@selectField}}
                @selectedField={{@selectedField}}
                @selectedFieldName={{@selectedFieldName}}
                @dropField={{@dropField}}
              />
            </div>
          {{/animated-value}}
        {{/if}}
      </div>
    </section>
  {{else if (eq @format "embedded")}}
    <div
      class="card-renderer-embedded
        {{concat (safe-css-string (if @card.canonicalURL @card.canonicalURL @card.adoptsFromURL)) "--embedded" }}
        {{@class}}
      "
      data-test-card-renderer-embedded={{@card.canonicalURL}}
      data-test-card-renderer-embedded-loaded={{stringify this.loadCard.isIdle}}
    >
      {{#if (and (eq this.mode "view") (not @preventIsolation))}}
        <LinkTo
          @class="card-renderer--embedded-card-link"
          @route="cards.card.view"
          @model={{@card.canonicalURL}}
          aria-label={{@card.csTitle}}
        >
          <Scaffold
            @card={{@card}}
            @feature="embedded-layout"
            @mode={{this.mode}} />
        </LinkTo>
      {{else}}
        <Scaffold
          @card={{@card}}
          @feature="embedded-layout"
          @mode={{this.mode}} />
        {{#if @showName}}
          <div class="embedded-card-label">{{@card.csTitle}}</div>
        {{/if}}
      {{/if}}
    </div>
  {{/if}}

  {{!-- TODO eventually we need to get smarter about writing out this CSS so that
  we eliminate dupe style definitions. Maybe there is a service that actually has
  the ability to know what all cards are on the page and spit out the most
  efficient CSS so that cards that leverage a common parent's CSS all get
  collasped into a single style element --}}
  {{#if (and (not this.css) this.loadCard.isRunning)}}
    <style
      data-test-view-css={{@card.canonicalURL}}
      data-test-view-css-format={{@format}}
    >
      {{#if (eq @format "isolated")}}
        {{scope-css this.loadingIsolatedCss (concat (safe-css-string @card.canonicalURL) "--" @format)}}
      {{else}}
        {{scope-css this.loadingEmbeddedCss (concat (safe-css-string @card.canonicalURL) "--" @format)}}
      {{/if}}
    </style>
  {{else if this.css}}
    <style
      data-test-view-css={{@card.canonicalURL}}
      data-test-view-css-format={{@format}}
    >
      {{scope-css this.css (concat (safe-css-string @card.canonicalURL) "--" @format)}}
    </style>
  {{/if}}
{{/if}}